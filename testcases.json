{
  "modules": [
    {
      "name": "充电站费率管理",
      "sub_modules": [
        {
          "name": "费率初始化",
          "test_cases": [
            {
              "expected_result": "1. 自动创建tariff记录（region_code=DE, currency=EUR, type=REGULAR, tax_included=YES）\n2. 创建tariff_element记录（全天时段00:00-24:00）\n3. 创建price_components记录（ENERGY默认0.10, PARKING_TIME默认0.10, 税率10%）\n4. 创建restrictions记录（min_duration=1800即30分钟免收时长）\n5. 创建station_rate_version记录（status=1生效中, adjustment_id=NULL, has_parking_fee=1, parking_free_duration=30）\n6. 版本号格式为STATION_{stationId}V001{timestamp}",
              "preconditions": "系统中存在有效的地区配置（如DE/EUR），充电站尚未创建",
              "steps": "1. 创建一个新的充电站（地区=DE）\n2. 检查station_rate_version表是否自动生成记录\n3. 检查tariff、tariff_element、price_components、restrictions表数据",
              "title": "充电站创建时自动生成初始费率版本"
            },
            {
              "expected_result": "站下所有充电枪在gun_tariff表中均关联到初始tariff_id，所有枪共享同一个tariff_id",
              "preconditions": "充电站已创建并生成初始费率，站下有2个充电枪",
              "steps": "1. 创建充电站并生成初始费率\n2. 查询gun_tariff表确认充电枪关联情况",
              "title": "初始费率自动同步到充电枪"
            },
            {
              "expected_result": "整个初始化过程回滚，tariff、tariff_element、price_components、restrictions、station_rate_version、gun_tariff表均无新增记录",
              "preconditions": "模拟数据库写入异常场景",
              "steps": "1. 创建充电站时模拟tariff表写入失败\n2. 检查所有相关表数据是否回滚",
              "title": "初始费率生成失败时事务回滚"
            },
            {
              "expected_result": "返回true，表示有人工设置的生效费率",
              "preconditions": "充电站已通过调价申请设置了费率（adjustment_id IS NOT NULL, status=1）",
              "steps": "1. 调用hasValidRateVersion接口查询该充电站",
              "title": "充电站费率状态判断-有人工设置费率"
            },
            {
              "expected_result": "返回false，初始化费率不算人工设置的费率",
              "preconditions": "充电站仅有系统自动生成的初始费率（adjustment_id=NULL, status=1）",
              "steps": "1. 调用hasValidRateVersion接口查询该充电站",
              "title": "充电站费率状态判断-仅有初始费率"
            }
          ]
        },
        {
          "name": "费率查询-当前费率",
          "test_cases": [
            {
              "expected_result": "返回当前生效费率版本信息，包含版本号、生效时间、税率、时段费率列表、是否有占位费、免收时长、设置人、备注",
              "preconditions": "充电站ID=12345存在且有生效中的费率版本（status=1）",
              "steps": "1. 调用GET /web/station-rate/detail?stationId=12345",
              "title": "查询充电站当前生效费率-正常场景"
            },
            {
              "expected_result": "返回错误码404或空数据",
              "preconditions": "充电站ID=99999不存在",
              "steps": "1. 调用GET /web/station-rate/detail?stationId=99999",
              "title": "查询充电站当前生效费率-充电站不存在"
            },
            {
              "expected_result": "返回3个时段的费率信息，每个时段包含不同的电费单价和占位费单价，含税价格计算正确",
              "preconditions": "充电站配置了3个时段的分时电价（峰时08:00-12:00、平时12:00-20:00、谷时20:00-08:00）",
              "steps": "1. 调用GET /web/station-rate/detail查询该充电站",
              "title": "查询充电站费率-含分时电价"
            }
          ]
        },
        {
          "name": "费率查询-历史费率",
          "test_cases": [
            {
              "expected_result": "默认返回20条历史费率，按生效开始时间倒序排列",
              "preconditions": "充电站有15条历史费率版本记录",
              "steps": "1. 调用GET /web/station-rate/detail?stationId=12345（不传分页参数）",
              "title": "查询历史费率-默认分页"
            },
            {
              "expected_result": "历史费率列表包含所有状态的费率版本（待生效、生效中、已失效、已作废），审批中的版本显示开始日期+结束日期（审批中）",
              "preconditions": "充电站有待生效、生效中、已失效、已作废等不同状态的费率版本",
              "steps": "1. 调用GET /web/station-rate/detail查询该充电站",
              "title": "查询历史费率-包含各种状态"
            },
            {
              "expected_result": "返回第2页的10条历史费率记录，按生效时间倒序排列",
              "preconditions": "充电站有50条历史费率版本记录",
              "steps": "1. 调用GET /web/station-rate/detail?stationId=12345&pageNum=2&pageSize=10",
              "title": "查询历史费率-分页查询"
            }
          ]
        },
        {
          "name": "费率导出",
          "test_cases": [
            {
              "expected_result": "返回OSS地址，下载的Excel文件包含3个充电站的费率信息，格式与国际价格导入模版一致",
              "preconditions": "选择了3个有生效费率的充电站",
              "steps": "1. 调用POST /web/station-rate/export，传入3个充电站ID",
              "title": "导出充电站费率信息-正常场景"
            },
            {
              "expected_result": "正常导出，无费率的充电站对应行费率字段为空或显示默认值",
              "preconditions": "选择的充电站中有一个没有生效费率",
              "steps": "1. 调用POST /web/station-rate/export",
              "title": "导出充电站费率信息-充电站无费率"
            }
          ]
        },
        {
          "name": "费率同步到充电枪",
          "test_cases": [
            {
              "expected_result": "3个充电枪的gun_tariff记录全部更新为新的tariff_id",
              "preconditions": "充电站下有3个充电枪，当前费率tariff_id=1001",
              "steps": "1. 通过调价申请将费率更新为tariff_id=1002\n2. 查询gun_tariff表",
              "title": "站点费率更新时同步到所有充电枪"
            },
            {
              "expected_result": "新增充电枪自动关联到当前生效的tariff_id",
              "preconditions": "充电站已有生效费率tariff_id=1001",
              "steps": "1. 在该充电站下新增一个evse/connector\n2. 查询新增枪的gun_tariff记录",
              "title": "新增充电枪时自动关联当前生效费率"
            },
            {
              "expected_result": "整个同步操作回滚，所有枪的gun_tariff保持原状态，记录错误日志",
              "preconditions": "充电站下有5个充电枪，模拟第3个枪同步失败",
              "steps": "1. 触发费率同步操作\n2. 模拟部分枪同步失败",
              "title": "费率同步失败时事务回滚"
            },
            {
              "expected_result": "桩下所有枪的tariff_id更新为站点B的当前生效费率",
              "preconditions": "充电桩从站点A（tariff_id=1001）移到站点B（tariff_id=2001）",
              "steps": "1. 执行移桩操作，将桩从站点A移到站点B\n2. 查询该桩下所有枪的gun_tariff",
              "title": "移桩场景-桩关联站点变化时刷新枪费率"
            }
          ]
        }
      ]
    },
    {
      "name": "调价申请管理",
      "sub_modules": [
        {
          "name": "创建调价申请-快捷设置",
          "test_cases": [
            {
              "title": "快捷设置创建调价申请-正常场景",
              "preconditions": "存在3个同地区(DE)的自营站充电站，运营商=XPENG，渠道=XPG，无流程中的申请",
              "steps": "1. 选择3个充电站\n2. 设置电费单价0.15EUR/kWh，有占位费，免收时长30分钟，占位费0.10EUR/分钟\n3. 选择立即生效\n4. 调用POST /web/price-adjustment/create",
              "expected_result": "1. 创建tariff_adjustment_request记录（status=0待审核）\n2. 为这批充电站创建同一个新的tariff结构\n3. 创建tariff_adjustment_station记录，包含old_tariff_id和new_tariff_id\n4. 自动生成调整内容说明"
            },
            {
              "title": "快捷设置-充电站数量超过100个",
              "preconditions": "选择了101个充电站",
              "steps": "1. 选择101个充电站\n2. 调用创建调价申请接口",
              "expected_result": "返回错误码400，提示充电站数量不超过100个"
            },
            {
              "title": "快捷设置-充电站不属于同一地区",
              "preconditions": "选择了2个充电站，一个属于DE，一个属于FR",
              "steps": "1. 选择不同地区的充电站\n2. 调用创建调价申请接口",
              "expected_result": "返回错误码400，提示所有充电站必须属于同一个地区"
            },
            {
              "title": "快捷设置-充电站有流程中的申请",
              "preconditions": "充电站A已有一个待审核的调价申请",
              "steps": "1. 选择充电站A\n2. 调用创建调价申请接口",
              "expected_result": "返回错误码400，提示充电站存在流程中的调价申请"
            },
            {
              "title": "快捷设置-充电站非自营站",
              "preconditions": "选择的充电站中包含非自营站（运营商非XPENG或渠道非XPG）",
              "steps": "1. 选择包含非自营站的充电站\n2. 调用创建调价申请接口",
              "expected_result": "返回错误码400，提示充电站不是自营站"
            },
            {
              "title": "快捷设置-电费单价超出范围",
              "preconditions": "正常的充电站选择",
              "steps": "1. 设置电费单价为10.00（超出[0,10)范围）\n2. 调用创建调价申请接口",
              "expected_result": "返回错误码400，提示电费单价必须在[0,10)范围内"
            },
            {
              "title": "快捷设置-电费单价超过货币阈值",
              "preconditions": "DE地区电费单价阈值为5.00EUR",
              "steps": "1. 设置电费单价为6.00EUR\n2. 调用创建调价申请接口",
              "expected_result": "返回错误码400，提示充电费单价超过系统设置的阈值"
            },
            {
              "title": "快捷设置-定时生效未填写生效时间",
              "preconditions": "正常的充电站选择",
              "steps": "1. 选择定时生效（effectiveType=2）\n2. 不填写effectiveTime\n3. 调用创建调价申请接口",
              "expected_result": "返回错误码400，提示生效时间必填"
            },
            {
              "title": "快捷设置-时段完整性校验失败",
              "preconditions": "正常的充电站选择",
              "steps": "1. 设置时段为00:00-12:00和14:00-24:00（12:00-14:00缺失）\n2. 调用创建调价申请接口",
              "expected_result": "返回错误码400，提示时段不完整，24小时必须无间隙"
            },
            {
              "title": "快捷设置-申请名称超长",
              "preconditions": "正常的充电站选择",
              "steps": "1. 输入超过64字符的申请名称\n2. 调用创建调价申请接口",
              "expected_result": "返回错误码400，提示申请名称最多64字符"
            },
            {
              "title": "快捷设置-申请说明不足6字符",
              "preconditions": "正常的充电站选择",
              "steps": "1. 输入5个字符的申请说明\n2. 调用创建调价申请接口",
              "expected_result": "返回错误码400，提示申请说明至少6字符"
            }
          ]
        },
        {
          "name": "创建调价申请-导入设置",
          "test_cases": [
            {
              "title": "Excel导入-正常场景",
              "preconditions": "准备包含3个同地区自营站充电站的Excel文件，数据格式正确",
              "steps": "1. 上传Excel文件\n2. 调用POST /web/price-adjustment/import-validate",
              "expected_result": "返回校验通过结果，包含totalCount=3、regionCode、taxRate、validStations列表，每个站点含含税价格和调整内容"
            },
            {
              "title": "Excel导入-文件格式错误",
              "preconditions": "准备一个.csv格式的文件",
              "steps": "1. 上传.csv文件\n2. 调用导入校验接口",
              "expected_result": "返回错误码400，提示文件格式错误，必须为.xlsx或.xls"
            },
            {
              "title": "Excel导入-数据超过100行",
              "preconditions": "准备包含101行数据的Excel文件",
              "steps": "1. 上传Excel文件\n2. 调用导入校验接口",
              "expected_result": "返回错误码400，提示数据行数超限，最多100条"
            },
            {
              "title": "Excel导入-必填字段为空",
              "preconditions": "Excel第2行的站ID为空",
              "steps": "1. 上传Excel文件\n2. 调用导入校验接口",
              "expected_result": "返回200，data为字符串：第2行 - {充电站名称}：站ID不能为空"
            },
            {
              "title": "Excel导入-电费单价格式错误",
              "preconditions": "Excel第3行电费单价填写为abc",
              "steps": "1. 上传Excel文件\n2. 调用导入校验接口",
              "expected_result": "返回200，data为字符串：第3行 - {充电站名称}：电费单价格式错误，必须为数字"
            },
            {
              "title": "Excel导入-充电站ID不存在",
              "preconditions": "Excel中包含不存在的充电站ID=99999",
              "steps": "1. 上传Excel文件\n2. 调用导入校验接口",
              "expected_result": "返回200，data为字符串：第X行 - {充电站名称}：充电站ID不存在"
            },
            {
              "title": "Excel导入-充电站不属于同一地区",
              "preconditions": "Excel中包含DE和FR两个地区的充电站",
              "steps": "1. 上传Excel文件\n2. 调用导入校验接口",
              "expected_result": "返回200，data为字符串：第X行 - {充电站名称}：所有充电站必须属于同一个地区"
            },
            {
              "title": "Excel导入-占位费为有但免收时长为空",
              "preconditions": "Excel中占位费填写有，但免收时长为空",
              "steps": "1. 上传Excel文件\n2. 调用导入校验接口",
              "expected_result": "返回200，data为字符串：第X行 - {充电站名称}：占位费免收时长不能为空"
            },
            {
              "title": "Excel导入-遇到第一个错误立即返回",
              "preconditions": "Excel第2行和第5行都有错误",
              "steps": "1. 上传Excel文件\n2. 调用导入校验接口",
              "expected_result": "仅返回第2行的错误信息，不继续校验后续行"
            }
          ]
        },
        {
          "name": "批量计算调整内容",
          "test_cases": [
            {
              "title": "批量计算调整内容-正常场景",
              "preconditions": "3个同地区(DE)自营站充电站，当前电费单价分别为0.10、0.12、0.18",
              "steps": "1. 传入3个充电站ID和新电费单价0.15\n2. 调用POST /web/price-adjustment/batch-calculate",
              "expected_result": "返回每个充电站的调整内容说明和含税价格，如电费单价从0.10调整为0.15 EUR/kWh"
            },
            {
              "title": "批量计算-新增占位费",
              "preconditions": "充电站原来无占位费",
              "steps": "1. 设置hasParkingFee=true，parkingFreeDuration=30，parkingPrice=0.10\n2. 调用批量计算接口",
              "expected_result": "调整内容包含新增占位费0.10 EUR/分钟，免收时长30分钟"
            },
            {
              "title": "批量计算-取消占位费",
              "preconditions": "充电站原来有占位费",
              "steps": "1. 设置hasParkingFee=false\n2. 调用批量计算接口",
              "expected_result": "调整内容包含取消占位费"
            },
            {
              "title": "批量计算-含税价格向上取整验证",
              "preconditions": "电费单价0.35，税率19%",
              "steps": "1. 传入电费单价0.35\n2. 调用批量计算接口",
              "expected_result": "充电费含税=0.35×1.19=0.4165，向上取整为0.42"
            }
          ]
        },
        {
          "name": "编辑调价申请",
          "test_cases": [
            {
              "title": "编辑审核不通过的调价申请",
              "preconditions": "存在一个审核不通过（status=3）的调价申请",
              "steps": "1. 修改申请内容\n2. 调用POST /web/price-adjustment/create（传入id）",
              "expected_result": "1. 更新调价申请信息\n2. 删除审核表中该申请id的相关审批记录\n3. 申请状态重置为待审核（status=0）"
            },
            {
              "title": "编辑复核不通过的调价申请",
              "preconditions": "存在一个复核不通过（status=4）的调价申请",
              "steps": "1. 修改申请内容\n2. 调用POST /web/price-adjustment/create（传入id）",
              "expected_result": "1. 更新调价申请信息\n2. 删除审核表中该申请id的相关审批记录\n3. 申请状态重置为待审核（status=0）"
            }
          ]
        },
        {
          "name": "删除调价申请",
          "test_cases": [
            {
              "title": "删除审核不通过的申请",
              "preconditions": "存在一个审核不通过（status=3）的调价申请",
              "steps": "1. 调用DELETE /web/price-adjustment/delete?adjustmentId=xxx",
              "expected_result": "逻辑删除成功（deleted=1），关联的tariff_adjustment_station和approval_record也被删除"
            },
            {
              "title": "删除复核不通过的申请",
              "preconditions": "存在一个复核不通过（status=4）的调价申请",
              "steps": "1. 调用DELETE /web/price-adjustment/delete?adjustmentId=xxx",
              "expected_result": "逻辑删除成功"
            },
            {
              "title": "删除待审核状态的申请",
              "preconditions": "存在一个待审核（status=0）的调价申请",
              "steps": "1. 调用DELETE /web/price-adjustment/delete?adjustmentId=xxx",
              "expected_result": "返回错误码400，提示只能删除审核不通过或复核不通过的申请"
            },
            {
              "title": "删除不存在的申请",
              "preconditions": "调价申请ID=99999不存在",
              "steps": "1. 调用DELETE /web/price-adjustment/delete?adjustmentId=99999",
              "expected_result": "返回错误码404"
            }
          ]
        },
        {
          "name": "调价申请列表查询",
          "test_cases": [
            {
              "title": "分页查询调价申请列表-默认参数",
              "preconditions": "系统中存在20条调价申请记录",
              "steps": "1. 调用GET /web/price-adjustment/list（不传参数）",
              "expected_result": "返回第1页10条记录，按创建时间倒序排列"
            },
            {
              "title": "按申请编号精确查询",
              "preconditions": "存在申请编号为ADJ_20250201_001的记录",
              "steps": "1. 调用GET /web/price-adjustment/list?requestNo=ADJ_20250201_001",
              "expected_result": "返回1条精确匹配的记录"
            },
            {
              "title": "按申请名称模糊查询",
              "preconditions": "存在多条包含德国的申请",
              "steps": "1. 调用GET /web/price-adjustment/list?requestName=德国",
              "expected_result": "返回所有申请名称包含德国的记录"
            },
            {
              "title": "按状态筛选",
              "preconditions": "存在不同状态的调价申请",
              "steps": "1. 调用GET /web/price-adjustment/list?status=0",
              "expected_result": "仅返回待审核状态的申请"
            },
            {
              "title": "按充电站ID精确查询",
              "preconditions": "充电站ID=12345关联了多个调价申请",
              "steps": "1. 调用GET /web/price-adjustment/list?stationId=12345",
              "expected_result": "返回所有关联充电站12345的调价申请"
            },
            {
              "title": "按时间范围查询",
              "preconditions": "存在不同时间创建的调价申请",
              "steps": "1. 调用GET /web/price-adjustment/list?startTime=2025-02-01 00:00:00&endTime=2025-02-28 23:59:59",
              "expected_result": "返回2月份创建的所有调价申请"
            }
          ]
        }
      ]
    },
    {
      "name": "审批流程与费率生效",
      "sub_modules": [
        {
          "name": "审核操作",
          "test_cases": [
            {
              "title": "审核通过-正常场景",
              "preconditions": "存在一个待审核（status=0）的调价申请，当前用户拥有审核角色权限",
              "steps": "1. 调用POST /web/price-adjustment/review\n2. 传入adjustmentId、approved=true、comment=费率调整合理",
              "expected_result": "1. 申请状态从0更新为1（待复核）\n2. 创建approval_record记录（approval_type=1审核, approval_result=1通过）\n3. 返回操作成功"
            },
            {
              "title": "审核不通过",
              "preconditions": "存在一个待审核（status=0）的调价申请，当前用户拥有审核角色权限",
              "steps": "1. 调用POST /web/price-adjustment/review\n2. 传入adjustmentId、approved=false、comment=费率不合理",
              "expected_result": "1. 申请状态从0更新为3（审核不通过）\n2. 创建approval_record记录（approval_type=1审核, approval_result=2不通过）"
            },
            {
              "title": "无审核权限审核",
              "preconditions": "存在一个待审核的调价申请，当前用户无审核角色权限",
              "steps": "1. 调用POST /web/price-adjustment/review",
              "expected_result": "返回错误码403，提示无权限"
            },
            {
              "title": "审核非待审核状态的申请",
              "preconditions": "存在一个待复核（status=1）的调价申请",
              "steps": "1. 调用POST /web/price-adjustment/review",
              "expected_result": "返回错误码400，提示申请状态不是待审核"
            }
          ]
        },
        {
          "name": "复核操作",
          "test_cases": [
            {
              "title": "复核通过-立即生效",
              "preconditions": "存在一个待复核（status=1）的调价申请，effectiveType=1立即生效，当前用户拥有复核角色权限",
              "steps": "1. 调用POST /web/price-adjustment/final-review\n2. 传入adjustmentId、approved=true",
              "expected_result": "1. 申请状态从1更新为2（审核通过）\n2. 创建approval_record记录（approval_type=2复核, approval_result=1通过）\n3. 执行税率锚定：重新获取最新税率，更新price_components的vat和price字段\n4. 旧费率版本status更新为2（已失效），设置expire_time\n5. 创建新费率版本station_rate_version（status=1生效中）\n6. 同步更新gun_tariff表\n7. 清除Redis缓存"
            },
            {
              "title": "复核通过-定时生效",
              "preconditions": "存在一个待复核（status=1）的调价申请，effectiveType=2定时生效，effective_time=2025-03-01 00:00:00",
              "steps": "1. 调用POST /web/price-adjustment/final-review\n2. 传入adjustmentId、approved=true",
              "expected_result": "1. 申请状态从1更新为2（审核通过）\n2. 执行税率锚定\n3. 创建新费率版本station_rate_version（status=0待生效）\n4. 旧费率版本保持status=1（生效中）\n5. gun_tariff不更新（等定时任务触发）"
            },
            {
              "title": "复核不通过",
              "preconditions": "存在一个待复核（status=1）的调价申请，当前用户拥有复核角色权限",
              "steps": "1. 调用POST /web/price-adjustment/final-review\n2. 传入adjustmentId、approved=false、comment=需要重新调整",
              "expected_result": "1. 申请状态从1更新为4（复核不通过）\n2. 创建approval_record记录（approval_type=2复核, approval_result=2不通过）\n3. 不执行税率锚定\n4. 不创建费率版本"
            },
            {
              "title": "无复核权限复核",
              "preconditions": "存在一个待复核的调价申请，当前用户无复核角色权限",
              "steps": "1. 调用POST /web/price-adjustment/final-review",
              "expected_result": "返回错误码403，提示无权限"
            },
            {
              "title": "复核非待复核状态的申请",
              "preconditions": "存在一个待审核（status=0）的调价申请",
              "steps": "1. 调用POST /web/price-adjustment/final-review",
              "expected_result": "返回错误码400，提示申请状态不是待复核"
            }
          ]
        },
        {
          "name": "税率锚定机制",
          "test_cases": [
            {
              "title": "复核通过时税率已变化",
              "preconditions": "调价申请创建时税率10%，复核通过时税率变为12%，电费单价0.15",
              "steps": "1. 创建调价申请（税率10%时）\n2. 审核通过\n3. 修改地区税率为12%\n4. 复核通过",
              "expected_result": "1. price_components的vat字段更新为12\n2. 充电费含税=0.15×1.12=0.168，向上取整为0.17\n3. 占位费含税=0.10×1.12=0.112，保留2位小数为0.12\n4. 锚定后的含税价格与申请时不同"
            },
            {
              "title": "立即生效后税率再变化不影响已生效费率",
              "preconditions": "费率版本已通过复核并立即生效，税率锚定为10%",
              "steps": "1. 修改地区税率为15%\n2. 查询已生效的费率版本",
              "expected_result": "已生效的费率版本的vat和含税价格不变，仍为10%"
            },
            {
              "title": "定时生效-复核到生效期间税率变化",
              "preconditions": "调价申请定时生效，复核通过时税率锚定为12%",
              "steps": "1. 复核通过（税率12%）\n2. 修改地区税率为15%\n3. 等待定时任务触发生效",
              "expected_result": "生效后的费率版本使用复核通过时锚定的12%税率，不受后续税率变化影响"
            }
          ]
        },
        {
          "name": "费率定时生效",
          "test_cases": [
            {
              "title": "定时任务正常触发生效",
              "preconditions": "存在一个待生效的费率版本（status=0），effective_time已到达",
              "steps": "1. 等待定时任务执行（每分钟检查）\n2. 检查费率版本状态",
              "expected_result": "1. 旧版本status更新为2（已失效），expire_time设置为当前时间\n2. 新版本status更新为1（生效中）\n3. gun_tariff表更新为新的tariff_id\n4. Redis缓存清除"
            },
            {
              "title": "定时任务处理多个待生效版本",
              "preconditions": "3个不同充电站各有一个待生效的费率版本，effective_time均已到达",
              "steps": "1. 等待定时任务执行\n2. 检查3个充电站的费率版本状态",
              "expected_result": "3个充电站的费率版本均正常生效，每个站点的旧版本失效、新版本生效、gun_tariff更新"
            },
            {
              "title": "定时生效失败-发送告警",
              "preconditions": "存在一个待生效的费率版本，模拟数据库更新失败",
              "steps": "1. 模拟定时任务执行时数据库异常\n2. 检查告警通知",
              "expected_result": "1. 费率版本状态不变（仍为待生效）\n2. 发送告警通知\n3. 事务回滚，数据一致性保持"
            },
            {
              "title": "定时任务分布式锁-单实例执行",
              "preconditions": "多个应用实例同时运行定时任务",
              "steps": "1. 同时触发多个实例的定时任务\n2. 检查执行情况",
              "expected_result": "只有一个实例获取到分布式锁并执行，其他实例跳过"
            }
          ]
        },
        {
          "name": "作废未来价格",
          "test_cases": [
            {
              "title": "作废单个待生效费率版本",
              "preconditions": "充电站A有1个待生效费率版本（2月3日生效）",
              "steps": "1. 调用POST /web/price-adjustment/cancel\n2. 传入rateVersionIds=[1003]",
              "expected_result": "费率版本status更新为3（已作废），remark记录作废原因"
            },
            {
              "title": "作废多个连续的待生效费率版本",
              "preconditions": "充电站A有3个待生效费率：2月1日、2月2日、2月3日",
              "steps": "1. 选择作废全部3个费率版本\n2. 调用作废接口",
              "expected_result": "3个费率版本全部更新为已作废状态"
            },
            {
              "title": "作废中间版本但未包含后续版本-校验失败",
              "preconditions": "充电站A有3个待生效费率：2月1日、2月2日、2月3日",
              "steps": "1. 仅选择作废2月1日的费率版本\n2. 调用作废接口",
              "expected_result": "返回错误码400，提示充电站存在未作废的后续费率版本，必须同时作废2月2日和2月3日的版本"
            },
            {
              "title": "作废最后一个待生效版本",
              "preconditions": "充电站A有3个待生效费率：2月1日、2月2日、2月3日",
              "steps": "1. 仅选择作废2月3日的费率版本\n2. 调用作废接口",
              "expected_result": "校验通过，2月3日的费率版本更新为已作废"
            },
            {
              "title": "作废不同地区的费率版本-校验失败",
              "preconditions": "充电站A（DE）和充电站B（FR）各有待生效费率版本",
              "steps": "1. 选择两个不同地区的费率版本\n2. 调用作废接口",
              "expected_result": "返回错误码400，提示所有充电站必须属于同一个地区"
            },
            {
              "title": "作废非待生效状态的费率版本",
              "preconditions": "费率版本status=1（生效中）",
              "steps": "1. 传入生效中的费率版本ID\n2. 调用作废接口",
              "expected_result": "返回错误码400，提示费率版本状态不是待生效，无法作废"
            }
          ]
        },
        {
          "name": "查询调价申请详情",
          "test_cases": [
            {
              "title": "审核人员查看申请详情-不返回审批记录",
              "preconditions": "存在一个待审核的调价申请，当前用户仅有审核角色",
              "steps": "1. 调用GET /web/price-adjustment/detail?adjustmentId=xxx",
              "expected_result": "返回申请基本信息、充电站费率列表（原费率vs新费率），approvalRecords为空列表"
            },
            {
              "title": "复核人员查看申请详情-返回审批记录",
              "preconditions": "存在一个待复核的调价申请，当前用户拥有复核角色",
              "steps": "1. 调用GET /web/price-adjustment/detail?adjustmentId=xxx",
              "expected_result": "返回申请基本信息、充电站费率列表、approvalRecords包含审核记录"
            },
            {
              "title": "同时拥有审核和复核角色查看详情",
              "preconditions": "当前用户同时拥有审核和复核角色",
              "steps": "1. 调用GET /web/price-adjustment/detail?adjustmentId=xxx",
              "expected_result": "返回审批记录（approvalRecords不为空）"
            }
          ]
        },
        {
          "name": "查询待生效费率列表",
          "test_cases": [
            {
              "title": "查询多个充电站的待生效费率",
              "preconditions": "充电站A有2个待生效费率，充电站B有1个待生效费率",
              "steps": "1. 调用GET /web/station-rate/pending-list?stationIds=12345,12346",
              "expected_result": "返回3条待生效费率记录，按生效时间正序排列"
            },
            {
              "title": "查询无待生效费率的充电站",
              "preconditions": "充电站C没有待生效的费率版本",
              "steps": "1. 调用GET /web/station-rate/pending-list?stationIds=12347",
              "expected_result": "返回空列表"
            }
          ]
        }
      ]
    },
    {
      "name": "充电订单创建与启动",
      "sub_modules": [
        {
          "name": "订单创建与预扣款",
          "test_cases": [
            {
              "expected_result": "1. 创建订单状态为WITHHOLDING\n2. 订单绑定当前生效的tariffId\n3. 记录pluggingTime为当前时间\n4. 发起预扣请求并同步等待响应\n5. 返回订单信息（orderId, orderNo, status=WITHHOLDING）",
              "preconditions": "用户无在途订单、无待支付订单，充电枪有生效费率",
              "steps": "1. 调用POST /web-h5/charging/start（gunId, authProtocolId, payType）",
              "title": "启动充电-正常创建订单"
            },
            {
              "expected_result": "返回错误：存在待支付订单，不允许启动新充电",
              "preconditions": "用户存在一个PAYMENT_PENDING状态的订单",
              "steps": "1. 调用POST /web-h5/charging/start",
              "title": "启动充电-存在待支付订单"
            },
            {
              "expected_result": "返回错误：在途订单超限",
              "preconditions": "用户已有5个在途订单（包含charging、withholding、wait_to_start、billing、settling、payment_pending）",
              "steps": "1. 调用POST /web-h5/charging/start",
              "title": "启动充电-在途订单达到5单"
            },
            {
              "expected_result": "返回错误：请勿重复提交",
              "preconditions": "用户同时发起2次启动充电请求",
              "steps": "1. 并发调用POST /web-h5/charging/start",
              "title": "启动充电-并发重复提交"
            },
            {
              "expected_result": "订单状态更新为TRANSACTION_CLOSED，释放预扣金",
              "preconditions": "订单已创建，预扣同步响应失败",
              "steps": "1. 启动充电，模拟预扣同步失败",
              "title": "启动充电-预扣同步失败"
            },
            {
              "expected_result": "1. 订单状态更新为WAIT_TO_START\n2. 生成messageId(UUID)并记录到order表\n3. 发送RequestStartTransactionRequest到Kafka",
              "preconditions": "订单状态为WITHHOLDING，收到预扣成功回调",
              "steps": "1. 模拟支付中台回调预扣成功",
              "title": "预扣成功-发送启动请求"
            },
            {
              "expected_result": "订单状态更新为TRANSACTION_CLOSED，释放预扣金",
              "preconditions": "订单状态为WITHHOLDING，预扣超时未成功",
              "steps": "1. 等待预扣超时",
              "title": "预扣超时-关闭订单"
            },
            {
              "expected_result": "订单绑定的tariffId为创建时刻的生效费率，后续费率变更不影响该订单的计费",
              "preconditions": "充电站有生效费率tariffId=1001",
              "steps": "1. 创建订单（绑定tariffId=1001）\n2. 充电站费率变更为tariffId=1002\n3. 检查订单绑定的tariffId",
              "title": "订单创建-费率快照绑定验证"
            }
          ]
        },
        {
          "name": "启动响应处理",
          "test_cases": [
            {
              "expected_result": "订单记录transactionId，等待TransactionEvent更新状态为CHARGING",
              "preconditions": "已发送RequestStartTransactionRequest，收到Accepted响应",
              "steps": "1. 模拟收到RequestStartTransactionResponse(status=Accepted, transactionId=xxx)",
              "title": "启动响应-Accepted"
            },
            {
              "expected_result": "释放预扣金，订单状态更新为TRANSACTION_CLOSED",
              "preconditions": "已发送RequestStartTransactionRequest，收到Rejected响应",
              "steps": "1. 模拟收到RequestStartTransactionResponse(status=Rejected)",
              "title": "启动响应-Rejected"
            },
            {
              "expected_result": "transactionId由RequestStartTransactionResponseListener绑定，不需要等到TransactionEvent(Started)",
              "preconditions": "已发送RequestStartTransactionRequest",
              "steps": "1. 收到RequestStartTransactionResponse(Accepted, transactionId=xxx)\n2. 检查订单transactionId字段",
              "title": "启动响应-transactionId绑定时机验证"
            }
          ]
        },
        {
          "name": "停止充电",
          "test_cases": [
            {
              "expected_result": "发送RequestStopTransactionRequest到Kafka，记录停止原因为APP停止",
              "preconditions": "订单状态为CHARGING",
              "steps": "1. 调用停止充电接口(orderId)",
              "title": "用户主动停止充电-正常"
            },
            {
              "expected_result": "返回错误：订单状态不允许停止",
              "preconditions": "订单状态为WAIT_TO_START",
              "steps": "1. 调用停止充电接口",
              "title": "停止充电-订单状态不允许"
            }
          ]
        }
      ]
    },
    {
      "name": "订单状态流转与OCPP事件处理",
      "sub_modules": [
        {
          "name": "TransactionEvent Updated处理",
          "test_cases": [
            {
              "title": "Updated事件-ChargingStateChanged触发状态变更为CHARGING",
              "preconditions": "订单状态为WAIT_TO_START",
              "steps": "收到TransactionEvent(Updated, triggerReason=ChargingStateChanged, chargingState=Charging)事件",
              "expected_result": "订单状态更新为CHARGING，记录充电开始时间，发送充电开始消息"
            },
            {
              "title": "Updated事件-EVConnected触发状态变更为BILLING",
              "preconditions": "订单状态为CHARGING",
              "steps": "收到TransactionEvent(Updated, chargingState=EVConnected)事件",
              "expected_result": "订单状态更新为BILLING（待结算），记录充电结束时间"
            },
            {
              "title": "Updated事件-WAIT_TO_START状态直接收到EVConnected",
              "preconditions": "订单状态为WAIT_TO_START",
              "steps": "收到TransactionEvent(Updated, chargingState=EVConnected)事件",
              "expected_result": "订单状态更新为BILLING，跳过CHARGING状态"
            },
            {
              "title": "Updated事件-非CHARGING状态跳过电量上报处理",
              "preconditions": "订单状态为WAIT_TO_START",
              "steps": "收到TransactionEvent(Updated, triggerReason=MeterValuePeriodic)事件",
              "expected_result": "跳过电量处理，记录日志，不更新电量数据"
            },
            {
              "title": "Updated事件-BILLING状态收到Charging事件被拒绝（状态回退）",
              "preconditions": "订单状态为BILLING",
              "steps": "收到TransactionEvent(Updated, triggerReason=ChargingStateChanged, chargingState=Charging)事件",
              "expected_result": "拒绝处理，CHARGING优先级(30)<BILLING优先级(40)，状态不回退"
            },
            {
              "title": "Updated事件-不允许的订单状态拒绝处理",
              "preconditions": "订单状态为SETTLING或COMPLETED",
              "steps": "收到TransactionEvent(Updated)事件",
              "expected_result": "bizCheck返回false，不处理该事件，记录日志"
            }
          ]
        },
        {
          "name": "TransactionEvent Ended处理",
          "test_cases": [
            {
              "title": "Ended事件-正常充电结束进入结算",
              "preconditions": "订单状态为CHARGING或BILLING",
              "steps": "收到TransactionEvent(Ended)事件",
              "expected_result": "记录充电结束时间、拔枪时间、停止原因、结束电表度数，同步Redis energy_detail到数据库，更新状态为SETTLING，清理Redis缓存，触发OcppSettlementHandler结算"
            },
            {
              "title": "Ended事件-WAIT_TO_START状态直接收到Ended",
              "preconditions": "订单状态为WAIT_TO_START",
              "steps": "收到TransactionEvent(Ended)事件",
              "expected_result": "允许处理，直接进入SETTLING状态触发结算"
            },
            {
              "title": "Ended事件-Redis无Session缓存时同步处理",
              "preconditions": "订单状态为CHARGING，Redis中无Session缓存",
              "steps": "收到TransactionEvent(Ended)事件",
              "expected_result": "记录警告日志'Redis中无Session缓存'，继续后续结算流程"
            },
            {
              "title": "Ended事件-不允许的订单状态拒绝处理",
              "preconditions": "订单状态为SETTLING或COMPLETED",
              "steps": "收到TransactionEvent(Ended)事件",
              "expected_result": "bizCheck返回false，不处理该事件"
            }
          ]
        },
        {
          "name": "TRANSACTION_CLOSED状态恢复流转",
          "test_cases": [
            {
              "title": "TRANSACTION_CLOSED收到Updated(Charging)恢复为CHARGING",
              "preconditions": "订单状态为TRANSACTION_CLOSED（启动超时后关闭）",
              "steps": "收到TransactionEvent(Updated, triggerReason=ChargingStateChanged, chargingState=Charging)事件",
              "expected_result": "订单状态恢复为CHARGING，清空abnormal_type/abnormal_desc/close_desc/close_time/close_operator字段"
            },
            {
              "title": "TRANSACTION_CLOSED收到Updated(EVConnected)恢复为BILLING",
              "preconditions": "订单状态为TRANSACTION_CLOSED",
              "steps": "收到TransactionEvent(Updated, chargingState=EVConnected)事件",
              "expected_result": "订单状态恢复为BILLING"
            },
            {
              "title": "TRANSACTION_CLOSED收到Ended事件恢复为SETTLING",
              "preconditions": "订单状态为TRANSACTION_CLOSED",
              "steps": "收到TransactionEvent(Ended)事件",
              "expected_result": "订单状态恢复为SETTLING，触发结算流程"
            },
            {
              "title": "TRANSACTION_CLOSED恢复流转无需重新预扣",
              "preconditions": "订单状态为TRANSACTION_CLOSED，原预扣金已释放",
              "steps": "收到TransactionEvent(Updated, chargingState=Charging)事件",
              "expected_result": "正常恢复为CHARGING状态，不发起新的预扣请求，可能产生坏账由公司承担"
            }
          ]
        },
        {
          "name": "状态优先级与乱序事件处理",
          "test_cases": [
            {
              "title": "状态有序推进-目标优先级高于当前允许转换",
              "preconditions": "订单状态为CHARGING(优先级30)",
              "steps": "触发状态转换到BILLING(优先级40)",
              "expected_result": "canTransition返回true，允许状态转换"
            },
            {
              "title": "状态回退拒绝-目标优先级低于当前不允许转换",
              "preconditions": "订单状态为BILLING(优先级40)",
              "steps": "触发状态转换到CHARGING(优先级30)",
              "expected_result": "canTransition返回false，拒绝状态转换"
            },
            {
              "title": "TRANSACTION_CLOSED允许转换到任意正常状态",
              "preconditions": "订单状态为TRANSACTION_CLOSED(优先级0)",
              "steps": "触发状态转换到CHARGING/BILLING/SETTLING等任意正常状态",
              "expected_result": "canTransition返回true，允许转换"
            },
            {
              "title": "乱序事件-BILLING状态收到Updated(Charging)被拒绝",
              "preconditions": "订单状态为BILLING",
              "steps": "收到乱序的Updated(Charging)事件",
              "expected_result": "CHARGING优先级(30)<BILLING优先级(40)，拒绝处理"
            },
            {
              "title": "乱序事件-BILLING状态收到Ended正常推进",
              "preconditions": "订单状态为BILLING",
              "steps": "收到Ended事件",
              "expected_result": "SETTLING优先级(50)>BILLING优先级(40)，允许正常推进"
            }
          ]
        }
      ]
    },
    {
      "name": "电量上报与费用计算",
      "sub_modules": [
        {
          "name": "电量上报处理",
          "test_cases": [
            {
              "expected_result": "记录startMeterValue和lastMeterValue，初始化energyDetail为空Map，缓存到Redis，标记为充电中订单",
              "preconditions": "订单状态为CHARGING，SessionBo中startMeterValue为null",
              "steps": "收到首帧电量报文TransactionEvent(Updated, triggerReason=MeterValuePeriodic)，携带Energy.Active.Import.Register=100kWh",
              "title": "首帧电量处理-初始化电量基准值"
            },
            {
              "expected_result": "计算电量差值5kWh，按时间占比分摊到对应时段，累加到energyDetail，更新总电量和预估费用，缓存到Redis",
              "preconditions": "订单状态为CHARGING，已有首帧电量记录，lastMeterValue=100kWh",
              "steps": "收到电量报文，currentMeterValue=105kWh",
              "title": "正常电量上报-计算电量差值并分时分摊"
            },
            {
              "expected_result": "过滤该电量数据，记录警告日志'电量异常：当前电量小于上次电量'，不更新电量数据",
              "preconditions": "订单状态为CHARGING，lastMeterValue=105kWh",
              "steps": "收到电量报文，currentMeterValue=100kWh（小于上次）",
              "title": "异常电量过滤-负值电量差值"
            },
            {
              "expected_result": "电量差值为0，不进行分时分摊，不更新总电量",
              "preconditions": "订单状态为CHARGING，lastMeterValue=105kWh",
              "steps": "收到电量报文，currentMeterValue=105kWh（与上次相同）",
              "title": "电量差值为0时不处理"
            },
            {
              "expected_result": "电量上报结果缓存到Redis，不直接写库，等待SessionSaveJob定时写库",
              "preconditions": "订单状态为CHARGING",
              "steps": "连续收到多次电量报文",
              "title": "电量上报结果缓存到Redis而非直接写库"
            }
          ]
        },
        {
          "name": "96分时电量分摊算法",
          "test_cases": [
            {
              "expected_result": "电量5kWh全部归属时段40(10:00-10:15)，energy_detail[40]+=5.0",
              "preconditions": "上次报文时间10:05，本次报文时间10:10，电量差值5kWh",
              "steps": "调用splitEnergyToSegments进行电量分摊",
              "title": "单时段内电量分摊-完全落在同一个15分钟时段"
            },
            {
              "expected_result": "时段40分配3.333kWh(5/15×10)，时段41分配6.667kWh(10/15×10)",
              "preconditions": "上次报文时间10:10，本次报文时间10:25，电量差值10kWh",
              "steps": "调用splitEnergyToSegments进行电量分摊",
              "title": "跨时段电量分摊-跨越两个15分钟时段"
            },
            {
              "expected_result": "电量按时间占比分摊到时段94、95　0　1等多个时段",
              "preconditions": "上次报文时间23:40，本次报文时间00:10（跨天），电量差值8kWh",
              "steps": "调用splitEnergyToSegments进行电量分摊",
              "title": "跨天电量分摊-跨越午夜时段"
            },
            {
              "expected_result": "时段索引计算正确：00:00→0, 06:30→26, 12:45→51, 23:45→95",
              "preconditions": "无",
              "steps": "验证时段索引计算公式: segmentIndex = (hour×4) + (minute/15)",
              "title": "时段索引计算正确性验证"
            },
            {
              "expected_result": "多次分摊结果累加到同一时段，总电量与各时段电量之和一致",
              "preconditions": "已有多次电量上报记录",
              "steps": "多次电量上报后检查energyDetail累加结果",
              "title": "电量累加正确性-多次上报同一时段累加"
            }
          ]
        },
        {
          "name": "充电费计算",
          "test_cases": [
            {
              "expected_result": "时段26电费=5.5×0.30×1.19=1.9635EUR，时段27电费=4.0×0.35×1.19=1.6660EUR，订单充电费=CEILING(3.6295,0.01)=3.63EUR",
              "preconditions": "48分时费率配置，税率19%，energy_detail包含时段52-55的电量数据",
              "steps": "调用generateSettlementDetail生成结算明细",
              "title": "充电费计算-48分时费率汇总96分时电量"
            },
            {
              "expected_result": "每个时段独立计算电费，无需汇总",
              "preconditions": "96分时费率配置，每15分钟一个时段",
              "steps": "调用generateSettlementDetail生成结算明细",
              "title": "充电费计算-96分时费率直接对应"
            },
            {
              "expected_result": "中间计算保留6位小数，最终金额向上取整到分（保留2位小数）",
              "preconditions": "多时段电费计算结果包含多位小数",
              "steps": "汇总各时段电费并应用CEILING取整",
              "title": "充电费取整规则-CEILING向上取整到分"
            },
            {
              "expected_result": "使用总电量×全天最低单价×(1+税率)计算，不标记异常单，settlement_detail中tariffType='fallback'",
              "preconditions": "订单无energy_detail数据（电量报文缺失时间戳）",
              "steps": "触发结算流程",
              "title": "降级计费-无分时电量数据时按最低单价计算"
            },
            {
              "expected_result": "生成包含startTime/endTime/energy/chargingFeeUnitPriceExclVat/vatRate/chargingFeeUnitPriceInclVat/chargingCost等字段的分时结算明细列表",
              "preconditions": "正常充电订单已完成电量上报",
              "steps": "调用generateSettlementDetail检查返回的settlement_detail结构",
              "title": "settlement_detail结构完整性验证"
            }
          ]
        },
        {
          "name": "SessionSaveJob定时写库",
          "test_cases": [
            {
              "expected_result": "批量获取Session缓存，合并更新kwh/estimatedCost/startDateTime/energyDetail到数据库，一次数据库操作完成",
              "preconditions": "Redis中有多个充电中订单的Session缓存",
              "steps": "触发OcppSessionSaveJob执行",
              "title": "SessionSaveJob-正常批量写库"
            },
            {
              "expected_result": "记录日志'OcppSessionSaveJob 无充电中订单'，返回SUCCESS",
              "preconditions": "Redis中无充电中订单",
              "steps": "触发OcppSessionSaveJob执行",
              "title": "SessionSaveJob-无充电中订单时跳过"
            },
            {
              "expected_result": "过滤无效订单，清理其Redis缓存，仅处理有效订单",
              "preconditions": "Redis中包含CHARGING和COMPLETED状态的订单",
              "steps": "触发OcppSessionSaveJob执行",
              "title": "SessionSaveJob-过滤无效状态订单并清理缓存"
            },
            {
              "expected_result": "异常订单记录错误日志，不影响其他订单的处理",
              "preconditions": "某个订单的Session缓存写库失败",
              "steps": "触发OcppSessionSaveJob执行",
              "title": "SessionSaveJob-单个订单写库异常不影响其他订单"
            }
          ]
        }
      ]
    },
    {
      "name": "费控机制",
      "sub_modules": [
        {
          "name": "费控触发与停止充电",
          "test_cases": [
            {
              "expected_result": "触发费控停止，发送RequestStopTransactionRequest到充电桩，订单状态变更为BILLING",
              "preconditions": "订单状态为CHARGING，预扣金额100EUR，费控阈值5%",
              "steps": "电量上报后当前电费总额达到95.80EUR（超过停止阈值95EUR）",
              "title": "费控触发-当前电费超过预扣金额95%触发停止充电"
            },
            {
              "expected_result": "不触发费控停止，继续充电",
              "preconditions": "订单状态为CHARGING，预扣金额100EUR，费控阈值5%",
              "steps": "电量上报后当前电费总额为90EUR（未超过停止阈值95EUR）",
              "title": "费控未触发-当前电费未超过阈值继续充电"
            },
            {
              "expected_result": "停止阈值=100×(1-5%)=95EUR，当前电费总额>95时触发",
              "preconditions": "预扣金额100EUR，费控阈值5%",
              "steps": "验证费控计算公式：停止阈值=预扣金额×(1-费控阈值)",
              "title": "费控计算公式验证"
            },
            {
              "expected_result": "每次电量上报后都调用feeControlService.checkAndTriggerFeeControl进行费控检查",
              "preconditions": "订单状态为CHARGING",
              "steps": "连续多次电量上报",
              "title": "费控检查频率-每次电量上报后都进行检查"
            },
            {
              "expected_result": "费控停止后订单状态变为BILLING，等待拔枪后进入结算",
              "preconditions": "订单状态为CHARGING，费控触发停止",
              "steps": "费控触发后检查订单状态变更",
              "title": "费控停止后订单状态变更为BILLING"
            },
            {
              "expected_result": "预扣金额为0时，停止阈值=0，首次电量上报即触发费控停止",
              "preconditions": "订单状态为CHARGING，预扣金额为0",
              "steps": "电量上报后进行费控检查",
              "title": "边界-预扣金额为0时的费控处理"
            }
          ]
        }
      ]
    },
    {
      "name": "订单结算",
      "sub_modules": [
        {
          "name": "充电费结算",
          "test_cases": [
            {
              "expected_result": "读取energy_detail，根据tariff_id获取费率配置，按费率时段汇总电量并计算电费，生成settlement_detail并存储",
              "preconditions": "订单状态为SETTLING，energy_detail已同步到数据库",
              "steps": "触发OcppSettlementHandler结算",
              "title": "正常结算-基于energy_detail生成settlement_detail"
            },
            {
              "expected_result": "使用总电量×全天最低单价×(1+税率)计算，settlement_detail中tariffType='fallback'，fallbackReason='NO_ENERGY_DETAIL'",
              "preconditions": "订单状态为SETTLING，energy_detail为空或null",
              "steps": "触发OcppSettlementHandler结算",
              "title": "降级结算-无energy_detail时按最低单价计算"
            },
            {
              "expected_result": "抛出BusinessException'获取费率配置失败'，结算失败等待重试",
              "preconditions": "订单状态为SETTLING，tariff_id对应的费率不存在",
              "steps": "触发OcppSettlementHandler结算",
              "title": "结算失败-获取费率配置失败"
            }
          ]
        },
        {
          "name": "占位费计算",
          "test_cases": [
            {
              "expected_result": "占位费起始时间=14:30+15分钟=14:45，占位时长25分钟，占位费=25×0.10×1.19=2.975≈2.98EUR",
              "preconditions": "充电结束时间14:30，拔枪时间15:10，免收时长15分钟，占位费单价0.10EUR/分钟，税率19%",
              "steps": "调用calculateIdleFee计算占位费",
              "title": "占位费计算-正常场景含免收时长"
            },
            {
              "expected_result": "时段1(17:40-18:00)白天费率=20×0.05×1.19=1.19EUR，时段2(18:00-18:45)晚间费率=45×0.08×1.19=4.284EUR，总计=CEILING(5.474,0.01)=5.48EUR",
              "preconditions": "充电结束17:30，拔枪18:45，免收时长10分钟，白天时段(09:00-18:00)单价0.05EUR/分钟，晚间时段(18:00-22:00)单价0.08EUR/分钟",
              "steps": "调用calculateIdleFee计算分时占位费",
              "title": "分时占位费计算-跨越不同费率时段"
            },
            {
              "expected_result": "占位费=0，不收取占位费",
              "preconditions": "充电站未启用占位费（无PARKING_TIME类型价格组件）",
              "steps": "调用calculateIdleFee计算占位费",
              "title": "占位费-充电站未启用占位费返回0"
            },
            {
              "expected_result": "占位费=0，异常订单不收取占位费",
              "preconditions": "订单已标记异常类型(abnormalType不为空)",
              "steps": "调用calculateIdleFee计算占位费",
              "title": "占位费-异常订单不收取占位费"
            },
            {
              "expected_result": "占位费=0，停止原因在不收费列表中",
              "preconditions": "停止原因为EmergencyStop/GroundFault/OvercurrentFault/PowerLoss等配置的不收费停止原因",
              "steps": "调用calculateIdleFee计算占位费",
              "title": "占位费-停止原因在不收费列表中不收取"
            },
            {
              "expected_result": "正常计算占位费，停止原因不在不收费列表中",
              "preconditions": "停止原因为Remote/Local/SOCLimitReached/StoppedByEV等收费停止原因",
              "steps": "调用calculateIdleFee计算占位费",
              "title": "占位费-收费停止原因正常收取"
            },
            {
              "expected_result": "占位费=0，拔枪时间在免收时长内无需收取",
              "preconditions": "充电结束14:30，拔枪14:40，免收时长15分钟",
              "steps": "调用calculateIdleFee计算占位费",
              "title": "占位费-拔枪时间在免收时长内不收取"
            },
            {
              "expected_result": "占位费=阈值金额，不超过阈值",
              "preconditions": "占位时间很长，计算占位费超过阈值配置",
              "steps": "调用calculateIdleFee计算占位费并校验阈值",
              "title": "占位费阈值截断-超过阈值按阈值收取"
            },
            {
              "expected_result": "修正拔枪时间=充电结束时间，占位费=0",
              "preconditions": "拔枪时间早于充电结束时间",
              "steps": "调用calculateIdleFee计算占位费",
              "title": "占位费边界-拔枪时间早于充电结束时间修正"
            },
            {
              "expected_result": "标记异常NO_UNPLUGGING_TIME，占位费=0",
              "preconditions": "订单无拔枪时间(unpluggingTime=null)",
              "steps": "调用calculateIdleFee计算占位费",
              "title": "占位费边界-无拔枪时间标记异常"
            },
            {
              "expected_result": "无停止原因时默认收取占位费",
              "preconditions": "停止原因为空(stopReason=null)",
              "steps": "调用shouldChargeIdleFee判断是否收取",
              "title": "占位费-无停止原因时默认收取"
            }
          ]
        },
        {
          "name": "订单总费用与扣款",
          "test_cases": [
            {
              "expected_result": "扣款35.50EUR，释放剩余14.50EUR预扣金，订单状态变为COMPLETED",
              "preconditions": "预扣金额50EUR，订单总费用35.50EUR",
              "steps": "执行结算扣款流程",
              "title": "预扣充足-扣款实际费用并释放剩余"
            },
            {
              "expected_result": "扣款50EUR预扣金，生成15EUR待付订单，订单状态变为PAYMENT_PENDING",
              "preconditions": "预扣金额50EUR，订单总费用65EUR",
              "steps": "执行结算扣款流程",
              "title": "预扣不足-生成待付订单"
            },
            {
              "expected_result": "扣款50EUR，无剩余释放，订单状态变为COMPLETED",
              "preconditions": "预扣金额50EUR，订单总费用50EUR",
              "steps": "执行结算扣款流程",
              "title": "预扣刚好-扣款全部预扣金"
            },
            {
              "expected_result": "订单总费用=充电费(含税)+占位费(含税)，待扣款金额=MIN(总费用,预扣金额)，待支付金额=MAX(0,总费用-预扣金额)",
              "preconditions": "充电费和占位费均已计算完成",
              "steps": "验证订单总费用计算公式",
              "title": "订单总费用计算公式验证"
            }
          ]
        }
      ]
    },
    {
      "name": "异常处理",
      "sub_modules": [
        {
          "name": "启动超时",
          "test_cases": [
            {
              "expected_result": "订单状态变为TRANSACTION_CLOSED，停止原因设为SYSTEM_TIMEOUT，释放预扣金，发送启动失败消息，不标记异常单",
              "preconditions": "订单状态为WAIT_TO_START，超过180秒未收到ChargingStateChanged事件",
              "steps": "StartTimeoutCheckJob检测到超时，触发OcppStartTimeoutHandler",
              "title": "启动超时-180秒未收到充电开始事件关闭订单"
            },
            {
              "expected_result": "bizCheck返回false，不处理超时事件",
              "preconditions": "订单状态已变为CHARGING（已收到充电事件）",
              "steps": "StartTimeoutCheckJob触发OcppStartTimeoutHandler",
              "title": "启动超时-订单已开始充电时不处理超时"
            }
          ]
        },
        {
          "name": "充电超时",
          "test_cases": [
            {
              "expected_result": "设置充电结束时间和拔枪时间为当前时间，标记异常类型CHARGING_TIMEOUT，状态变为SETTLING，触发OcppSettlementHandler结算",
              "preconditions": "订单状态为CHARGING，超过6小时电量无变更",
              "steps": "ChargingTimeoutCheckJob检测到超时，触发OcppChargingTimeoutHandler",
              "title": "充电超时-6小时无电量变更自动结算"
            },
            {
              "expected_result": "bizCheck返回false，不处理超时事件",
              "preconditions": "订单状态已变为BILLING或SETTLING",
              "steps": "ChargingTimeoutCheckJob触发OcppChargingTimeoutHandler",
              "title": "充电超时-订单已结束充电时不处理超时"
            },
            {
              "expected_result": "异常订单结算时占位费=0，仅计算充电费",
              "preconditions": "充电超时订单进入结算流程",
              "steps": "检查结算结果中占位费是否为0",
              "title": "充电超时结算-异常订单不收取占位费"
            }
          ]
        },
        {
          "name": "电量异常",
          "test_cases": [
            {
              "expected_result": "过滤该电量数据，记录警告日志，不标记异常单，仅做充电时长状态更新",
              "preconditions": "订单状态为CHARGING，当前电量小于上次电量",
              "steps": "收到负值电量差值的电量报文",
              "title": "电量异常-负值电量过滤不标记异常"
            },
            {
              "expected_result": "不标记异常单，订单状态不变更，继续充电",
              "preconditions": "订单状态为CHARGING，充电度数超过阈值",
              "steps": "电量上报检测到充电量过高",
              "title": "电量异常-使用中订单充电量过高不标记异常"
            },
            {
              "expected_result": "标记异常类型EXCESSIVE_ENERGY，仅允许人工操作结算",
              "preconditions": "订单状态为SETTLING，充电度数超过阈值",
              "steps": "结算时检测到充电量过高",
              "title": "电量异常-结算中订单充电量过高标记异常"
            }
          ]
        },
        {
          "name": "结算超时与重试",
          "test_cases": [
            {
              "expected_result": "重试结算，不标记异常单",
              "preconditions": "订单状态为SETTLING，超过5分钟未完成结算",
              "steps": "SettlementRetryJob触发重试结算",
              "title": "结算超时-5分钟未完成触发重试"
            },
            {
              "expected_result": "结算成功，订单状态变为COMPLETED或PAYMENT_PENDING",
              "preconditions": "结算重试中",
              "steps": "重试结算成功",
              "title": "结算重试成功-正常完成结算"
            },
            {
              "expected_result": "标记异常单，仅允许人工操作结算",
              "preconditions": "结算多次重试失败",
              "steps": "重试结算失败",
              "title": "结算重试失败-标记异常单"
            }
          ]
        },
        {
          "name": "拔枪时间异常与无拔枪超时",
          "test_cases": [
            {
              "expected_result": "修正拔枪时间=充电结束时间，不标记异常单，正常结算",
              "preconditions": "拔枪时间早于充电结束时间",
              "steps": "结算时检测到拔枪时间异常",
              "title": "拔枪时间异常-修正拔枪时间为充电结束时间"
            },
            {
              "expected_result": "自动结算，拔枪时间=充电结束时间，不标记异常单，不收取占位费",
              "preconditions": "订单状态为BILLING，超过6小时无拔枪时间",
              "steps": "WaitingSettlementTimeoutJob检测到超时",
              "title": "无拔枪超时-BILLING状态超过6小时自动结算"
            }
          ]
        }
      ]
    },
    {
      "name": "Admin后台管理",
      "sub_modules": [
        {
          "name": "订单关闭",
          "test_cases": [
            {
              "expected_result": "订单状态变为TRANSACTION_CLOSED，释放预扣金，记录异常类型和关闭描述，清理Redis缓存，记录操作日志",
              "preconditions": "订单状态为WAIT_TO_START/CHARGING/BILLING/SETTLING之一",
              "steps": "调用POST /web/order/self/close，传入orderId、abnormalType、closeDesc(至少6字符)",
              "title": "订单关闭-正常关闭在途订单"
            },
            {
              "expected_result": "返回错误码800002 ORDER_STATUS_NOT_ALLOW_CLOSE",
              "preconditions": "订单状态为COMPLETED或TRANSACTION_CLOSED",
              "steps": "调用POST /web/order/self/close",
              "title": "订单关闭-不允许关闭已完成/已关闭订单"
            },
            {
              "expected_result": "返回错误码502002 PARAM_INVALID",
              "preconditions": "订单状态为CHARGING",
              "steps": "调用POST /web/order/self/close，closeDesc长度小于6字符或超过512字符",
              "title": "订单关闭-关闭描述长度不符合要求"
            },
            {
              "expected_result": "返回错误码502404 ORDER_NOT_EXIST",
              "preconditions": "无",
              "steps": "调用POST /web/order/self/close，传入不存在的orderId",
              "title": "订单关闭-订单不存在"
            },
            {
              "expected_result": "释放预扣金失败记录日志，不阻塞关闭流程，订单仍成功关闭",
              "preconditions": "订单状态为CHARGING，支付中台释放预扣金接口异常",
              "steps": "调用POST /web/order/self/close",
              "title": "订单关闭-释放预扣金失败不阻塞关闭流程"
            }
          ]
        },
        {
          "name": "异常结算预览",
          "test_cases": [
            {
              "expected_result": "返回订单基本信息：orderId、orderNo、orderStatus、stationName、chargeType、chargingStartTime",
              "preconditions": "订单已标记异常类型",
              "steps": "调用GET /web/order/self/abnormalSettlePreview?orderId=xxx",
              "title": "异常结算预览-正常返回订单信息"
            },
            {
              "expected_result": "返回错误码800004 ORDER_NOT_ABNORMAL",
              "preconditions": "订单未标记异常类型",
              "steps": "调用GET /web/order/self/abnormalSettlePreview?orderId=xxx",
              "title": "异常结算预览-非异常订单拒绝预览"
            }
          ]
        },
        {
          "name": "异常结算",
          "test_cases": [
            {
              "expected_result": "根据传入的计费信息计算费用，执行扣款，订单状态变为COMPLETED或PAYMENT_PENDING",
              "preconditions": "订单状态为WAIT_TO_START/CHARGING/BILLING/SETTLING之一，已标记异常",
              "steps": "调用POST /web/order/self/abnormalSettle，传入orderId、chargingEndTime、unpluggingTime、abnormalReason、abnormalDesc、settlementSegment",
              "title": "异常结算-正常执行异常结算"
            },
            {
              "expected_result": "返回错误码800006 UNPLUGGING_TIME_INVALID",
              "preconditions": "订单已标记异常",
              "steps": "调用POST /web/order/self/abnormalSettle，unpluggingTime早于chargingEndTime",
              "title": "异常结算-拔枪时间早于充电结束时间拒绝"
            },
            {
              "expected_result": "返回错误码502002 PARAM_INVALID",
              "preconditions": "订单已标记异常",
              "steps": "调用POST /web/order/self/abnormalSettle，abnormalDesc长度小于6字符",
              "title": "异常结算-异常描述长度不符合要求"
            },
            {
              "expected_result": "返回错误码800004 ORDER_NOT_ABNORMAL",
              "preconditions": "订单未标记异常类型",
              "steps": "调用POST /web/order/self/abnormalSettle",
              "title": "异常结算-非异常订单拒绝结算"
            }
          ]
        },
        {
          "name": "订单详情扩展",
          "test_cases": [
            {
              "expected_result": "返回包含transactionId、tariffId、tariffVersion、isAbnormal、abnormalType、pluggingTime、chargingStartTime、chargingEndTime、unpluggingTime、settlementTime、startMeterValue、endMeterValue、payableAmount、ocppStoppedReason、settlementDetail等新增字段",
              "preconditions": "自营站订单已完成结算",
              "steps": "调用GET /web/order/orderDetails?orderId=xxx",
              "title": "订单详情-自营站订单新增字段返回"
            },
            {
              "expected_result": "返回settlementDetail列表，包含各时段的startTime/endTime/energy/chargingCost/idleFeeCost等字段",
              "preconditions": "自营站订单已完成结算，有分时结算明细",
              "steps": "调用GET /web/order/orderDetails检查settlementDetail字段",
              "title": "订单详情-分时结算明细返回"
            },
            {
              "expected_result": "返囜loseTime和closeOperator字段有值",
              "preconditions": "自营站订单已关闭",
              "steps": "调用GET /web/order/orderDetails检查关闭订单信息",
              "title": "订单详情-关闭订单显示关闭时间和操作人"
            }
          ]
        }
      ]
    },
    {
      "name": "C端展示与APP充电流程",
      "sub_modules": [
        {
          "name": "地图/站详情/枪详情定价展示",
          "test_cases": [
            {
              "expected_result": "单站价格和单枪价格显示含税价格，与后台配置一致",
              "preconditions": "自营站已配置费率并生效",
              "steps": "在APP地图/站详情/枪详情页面查看价格信息",
              "title": "价格展示-单站和单枪价格含税显示正确"
            },
            {
              "expected_result": "显示当前时刻对应的充电费单价（含税）",
              "preconditions": "自营站配置了分时电价",
              "steps": "在枪详情页面查看当前时刻充电费",
              "title": "价格展示-当前时刻充电费含税显示"
            },
            {
              "expected_result": "显示当前时刻对应的占位费单价（含税）和免停时长",
              "preconditions": "自营站启用了占位费",
              "steps": "在枪详情页面查看当前时刻占位费和免停时长",
              "title": "价格展示-当前时刻占位费和免停时长显示"
            },
            {
              "expected_result": "不显示占位费相关信息",
              "preconditions": "自营站未启用占位费",
              "steps": "在枪详情页面查看价格信息",
              "title": "价格展示-未启用占位费时不显示占位费信息"
            }
          ]
        },
        {
          "name": "APP充电流程",
          "test_cases": [
            {
              "expected_result": "创建订单成功，发起预扣款，预扣成功后发送RequestStartTransactionRequest到充电桩",
              "preconditions": "用户已插枪，充电枪状态为Occupied",
              "steps": "用户在APP点击启动充电",
              "title": "APP启动充电-正常流程"
            },
            {
              "expected_result": "发送RequestStopTransactionRequest到充电桩，等待Updated(EVConnected)和Ended事件",
              "preconditions": "订单状态为CHARGING",
              "steps": "用户在APP点击停止充电",
              "title": "APP停止充电-正常流程"
            },
            {
              "expected_result": "校验不通过，提示用户在途订单过多",
              "preconditions": "用户在海外的在途单>=5单（状态为CHARGING/WITHHOLDING/WAIT_TO_START/BILLING/SETTLING/PAYMENT_PENDING）",
              "steps": "用户在APP点击启动充电",
              "title": "APP启动充电-在途单超过限制拒绝启动"
            },
            {
              "expected_result": "费控触发停止充电，发送RequestStopTransactionRequest到充电桩",
              "preconditions": "订单状态为CHARGING，余额不足",
              "steps": "电量上报后费控检查触发停止",
              "title": "APP充电中-费控余额不足自动停止充电"
            },
            {
              "expected_result": "自营站订单统一使用OCPP2.0.1协议启动充电，运营商=小鹏汽车(XPENG)，全部为直连平台",
              "preconditions": "自营站配置完成",
              "steps": "验证自营站订单启动方式和运营商标识",
              "title": "自营站订单标识-OCPP2.0.1协议与运营商标识"
            }
          ]
        }
      ]
    }
  ]
}